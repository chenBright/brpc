name: Build and Test on Linux

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**.md'
  pull_request:
    branches: [ master ]
    paths-ignore:
      - '**.md'

env:
  proc_num: $(nproc)

jobs:
  clang-unittest:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
    - uses: ./.github/actions/install-essential-dependences
    - name: install gtest
      run: |
           sudo apt-get update
           sudo apt-get install -y cmake libgtest-dev gdb
           cd /usr/src/gtest && sudo cmake . && sudo make && sudo mv lib/libgtest* /usr/lib/
    - uses: ./.github/actions/init-make-config
      with:
        options: --cc=clang --cxx=clang++
    - name: compile tests
      run: |
           cd test
           nm -D /usr/lib/x86_64-linux-gnu/libc.so.6 | grep pthread_mutex
           make -j ${{env.proc_num}} brpc_channel_unittest
    - name: run tests
      run: |
           cd test
           ldd brpc_channel_unittest
           LD_DEBUG=files  ./brpc_channel_unittest --gtest_filter=ChannelTest.success
